"use strict";!function(){function a(a){return Math.floor(a)}function d(a,b){return new v(a,b)}function e(a){return a+"px Impact, Charcoal, sans-serif"}function f(a,b,c,d){a.beginPath(),a.arc(b,c,d,0,2*Math.PI,!1),a.closePath()}function g(a,b,c,d,e,f,g,h,i){var j=a.createRadialGradient(b,c,d,e,f,g);return j.addColorStop(0,h),j.addColorStop(1,i),j}function h(a){var b=document.createElement("canvas"),c=b.getContext("2d");switch(b.width=352,b.height=240,a){case"Grid":c.fillStyle="black",c.fillRect(0,0,352,240),c.lineWidth=.5,c.strokeStyle="green";for(var d=0;d<23;++d)i(c,16*d,0,16*d,240);for(var d=0;d<16;++d)i(c,0,16*d,352,16*d);break;case"Sky":c.fillStyle=g(c,200,400,200,200,300,300,"blue","cornflowerblue"),c.fillRect(0,0,352,240),c.beginPath(),c.moveTo(0,175),c.quadraticCurveTo(240,150,352,170),c.lineTo(352,240),c.lineTo(0,240),c.closePath(),c.fillStyle=g(c,200,200,50,200,180,200,"green","darkgreen"),c.fill()}return b}function i(a,b,c,d,e){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.closePath(),a.stroke()}function j(){var a={};for(var b in{dirt:1,guy:2}){var c=document.createElement("canvas"),d=c.getContext("2d");c.width=256,c.height=128,d.fillStyle="black",k(a,b,d,c),a[b].canvas=c}return a}function k(a,b,c,d){a[b]={shapes:[]};var g,e=n[b+"P"],f="";switch(b){case"guy":var h=l("guy");for(q=0;q<5;q++){c.drawImage(h,24*q+8,8);var i=l("gun",q),j=n.gunO[q];console.log(j),c.drawImage(i,24*q+j[0],0+j[1]),c.save(),c.translate(24*(q+1)+24*q,0),c.scale(-1,1),c.drawImage(d,24*q,0,24,24,24*q,24,24,24),c.restore(),a[b].shapes.push({x:24*q,y:0,w:24,h:24}),a[b].shapes.push({x:24*q,y:24,w:24,h:24})}break;case"dirt":for(var k=32,p=0;p<3;p++)for(var q=0;q<3;q++){g=c.getImageData(8*q,8*p,8,8);for(var r=0;r<8;r++)for(var s=0;s<8;s++)if(f=m[e[n[b][r+4*p][s+4*q]]])for(var t=0;t<4;t++)g.data[4*(s+8*r)+t]=f[t]||255;c.putImageData(g,8*q,8*p)}for(var t=0,u=o.length;t<u;t++){for(var v=o[t],w={x:k,y:0,w:8*v[0],h:8*v[1]},s=0;s<v[0];s++)for(var r=0;r<v[1];r++){var x={};0===r?x.y=0:r<v[1]-1?x.y=1:x.y=2,0===s?x.x=0:s<v[0]-1?x.x=1:x.x=2,c.drawImage(d,8*x.x,8*x.y,8,8,8*s+k,8*r,8,8)}a[b].shapes.push(w),k+=8*v[0]}}}function l(a,b){var j,c=document.createElement("canvas"),d=c.getContext("2d"),e=n[a][b]||n[a],f=e[0].length,g=e.length,h=d.createImageData(f,g),i=n[a+"P"];c.width=f,c.height=g;for(var k=0;k<g;k++)for(var l=0;l<f;l++)if(j=m[i[e[k][l]]])for(var b=0;b<4;b++)h.data[4*(l+k*f)+b]=j[b]||255;return d.putImageData(h,0,0),c}function r(){this.setSettings=function(a){for(var b=0;b<24;b++)this[String.fromCharCode(97+b)]=a[b]||0;this.c<.01&&(this.c=.01);var c=this.b+this.c+this.e;if(c<.18){var d=.18/c;this.b*=d,this.c*=d,this.e*=d}}}function s(){this._params=new r;var a,b,c,d,e,f,g,h,i,j,k,l;this.reset=function(){var a=this._params;d=100/(a.f*a.f+.001),e=100/(a.g*a.g+.001),f=1-a.h*a.h*a.h*.01,g=-a.i*a.i*a.i*1e-6,a.a||(k=.5-a.n/2,l=5e-5*-a.o),h=1+a.l*a.l*(a.l>0?-.9:10),i=0,j=1==a.m?0:(1-a.m)*(1-a.m)*2e4+32},this.totalReset=function(){this.reset();var d=this._params;return a=d.b*d.b*1e5,b=d.c*d.c*1e5,c=d.e*d.e*1e5+12,3*((a+b+c)/3|0)},this.synthWave=function(m,n){var o=this._params,p=1!=o.s||o.v,q=o.v*o.v*.1,r=1+3e-4*o.w,s=o.s*o.s*o.s*.1,t=1+1e-4*o.t,u=1!=o.s,v=o.x*o.x,w=o.g,x=o.q||o.r,y=o.r*o.r*o.r*.2,z=o.q*o.q*(o.q<0?-1020:1020),A=o.p?((1-o.p)*(1-o.p)*2e4|0)+32:0,B=o.d,C=o.j/2,D=o.k*o.k*.01,E=o.a,F=a,G=1/a,H=1/b,I=1/c,J=5/(1+o.u*o.u*20)*(.01+s);J>.8&&(J=.8),J=1-J;for(var Q,S,U,W,Y,Z,K=!1,L=0,M=0,N=0,O=0,P=0,R=0,T=0,V=0,X=0,$=0,_=new Array(1024),aa=new Array(32),ba=_.length;ba--;)_[ba]=0;for(var ba=aa.length;ba--;)aa[ba]=2*Math.random()-1;for(var ba=0;ba<n;ba++){if(K)return ba;if(A&&++X>=A&&(X=0,this.reset()),j&&++i>=j&&(j=0,d*=h),f+=g,d*=f,d>e&&(d=e,w>0&&(K=!0)),S=d,C>0&&($+=D,S*=1+Math.sin($)*C),S|=0,S<8&&(S=8),E||(k+=l,k<0?k=0:k>.5&&(k=.5)),++M>F)switch(M=0,++L){case 1:F=b;break;case 2:F=c}switch(L){case 0:N=M*G;break;case 1:N=1+2*(1-M*H)*B;break;case 2:N=1-M*I;break;case 3:N=0,K=!0}x&&(z+=y,U=0|z,U<0?U=-U:U>1023&&(U=1023)),p&&r&&(q*=r,q<1e-5?q=1e-5:q>.1&&(q=.1)),Z=0;for(var ca=8;ca--;){if(T++,T>=S&&(T%=S,3==E))for(var da=aa.length;da--;)aa[da]=2*Math.random()-1;switch(E){case 0:Y=T/S<k?.5:-.5;break;case 1:Y=1-T/S*2;break;case 2:W=T/S,W=6.28318531*(W>.5?W-1:W),Y=1.27323954*W+.405284735*W*W*(W<0?1:-1),Y=.225*((Y<0?-1:1)*Y*Y-Y)+Y;break;case 3:Y=aa[Math.abs(32*T/S|0)]}p&&(Q=R,s*=t,s<0?s=0:s>.1&&(s=.1),u?(P+=(Y-R)*s,P*=J):(R=Y,P=0),R+=P,O+=R-Q,O*=1-q,Y=O),x&&(_[V%1024]=Y,Y+=_[(V-U+1024)%1024],V++),Z+=Y}Z*=.125*N*v,m[ba]=Z>=1?32767:Z<=-1?-32768:32767*Z|0}return n}}function v(a,b){return this.x=a||0,this.y=b||0,this}function x(a){function x(a){if(v=n(x),!(a<e+j)){for(d+=a-e,e=a,r(b,a,d),a>g+1e3&&(f=.25*h+.75*f,g=a,h=0),h++,i=0;d>=c;)if(s(b,c),d-=c,++i>=240){m=!0;break}t(b,d/c),u(b,f,m),m=!1}}var b=this;this.init(a);var v,c=1e3/60,d=0,e=0,f=60,g=0,h=0,i=0,j=0,k=!1,l=!1,m=!1,n=q?function(){var b,d,a=Date.now();return function(e){return b=Date.now(),d=Math.max(0,c-(b-a)),a=b+d,setTimeout(function(){e(b+d)},d)}}():window.requestAnimationFrame,o=q?clearTimeout:window.cancelAnimationFrame,p=function(){},r=p,s=p,t=p,u=p,w={setBegin:function(a){return r=a||r,this},setUpdate:function(a){return s=a||s,this},setDraw:function(a){return t=a||t,this},setEnd:function(a){return u=a||u,this},start:function(){return l||(l=!0,v=n(function(a){t(b,1),k=!0,e=a,g=a,h=0,v=n(x)})),this},stop:function(){return k=!1,l=!1,o(v),this},isRunning:function(){return k}};this.mainLoop=w,w.setBegin(this.begin),w.setUpdate(this.update),q||w.setDraw(this.render),w.setEnd(this.end),w.start()}function y(a){var b=new B({game:a});return b.game=a,b.type="Explosion",b.visible=!1,b.fillStyle="white",b.explode=function(b){this.x=b.x-10,this.y=b.y-10,this.w=2,this.h=2,this.alpha=1,this.visible=!0,a.activeExplosions.push(this)},b.update=function(b){this.alpha*=.9,this.x-=.05*this.w,this.y-=.05*this.h,this.w*=1.1,this.h*=1.1,this.alpha<.1&&(a.activeExplosions.splice(a.activeExplosions.indexOf(this),1),a.explosions.push(this))},b}function A(a){var b=new B(a);switch(b.speed=300,b.accel=3,b.gravity=.01,b.moveVec=d(.3,0),b.type){case"Player":b.fI=300;break;case"Enemy":b.id=z++,b.game.bullets[b.id]={},b.fI=600,b.health=a.health||1}b.grounded=!1,b.jP=40,b.jT=.12,b.jTr=b.jT,b.pInp=[],b.lastInput=-1,b.flipped=!1,b.flip=!1,b.fired=!1,b.fT=0,b.fV=d(),b.fS=12,b.tempVec=d(),b.connected=!0,b.damaged=!1,b.wins=0,b.dead=!1;var c=b.update;return b.update=function(a){c(a,this),"Player"===this.type,this.damaged&&Date.now()>this.damaged&&(this.damaged=!1),this.damaged?this.fillStyle="white":"Player"===this.type?this.fillStyle="purple":this.fillStyle="orange",this.fired&&Date.now()>this.fT+this.fI&&(this.fired=!1),"Enemy"!==this.type||this.dead||(this.vel.y>3&&!this.flip&&(this.flip=!0,this.vel.x*=Math.random()>.5?-1:1),this.vel.y<.3&&(this.flip=!1),this.vel.x+=this.moveVec.x*(1/a),this.pos.dis(this.game.player)<100&&(this.fV.copy(this.game.player.pos),this.tempVec.copy(this.game.player.pos).sub(this.pos),this.tempVec.mag()>100&&(Math.abs(this.tempVec.x)>50&&(this.tempVec.x>0?this.fV.x-=this.game.w:this.fV.x+=this.game.w),Math.abs(this.tempVec.y)>50&&(this.tempVec.y>0?this.fV.y-=this.game.h:this.fV.y+=this.game.h)),this.fV.sub(this.pos).normalize().scl(this.fS),b.fireBullet({}))),q||this.aimWeapon()},b.aimWeapon=function(){this.rL.copy(this.pos).sub({x:8,y:8});var a=this.game.assets[this.style].shapes;switch(this.fV.octDir()){case 0:this.shp=a[5];break;case 1:this.shp=a[7];break;case 2:this.shp=this.flipped?a[8]:a[9];break;case 3:this.shp=a[6];break;case 4:case-4:this.shp=a[4];break;case-3:this.shp=a[2];break;case-2:this.shp=this.flipped?a[0]:a[1];break;case-1:this.shp=a[3]}},b.fireBullet=function(a){this.fired||(this.game.addBullet({x:this.x+4,y:this.y+4,vel:this.fV,fT:Date.now(),id:a.inputSeq||0,parent:this}),this.fT=Date.now(),this.fired=!0)},b.takeDamage=function(a,b){if(q||(this===this.game.player?u.play("hurt",.5,!1):u.play("hit",.5,!1)),!this.dead){if(this.health-=a,this.health<=0)switch(this.dead=!0,this.type){case"Player":q||(this===this.game.player?u.play("died",.5,!1):u.play("kill",.4,!1)),console.log("you dead"),this.game.deadPlayers++,this.game.singlePlayer&&this.game.matchOver();break;case"Enemy":q||u.play("kill",.4,!1),this.game.explosions.pop().explode({x:this.pos.x,y:this.pos.y}),this.vel.clear(),this.gravity=.01,this.game.deadEnemies++}this.vel.add(b.normalize().scl(5)),this.damaged=Date.now()+100}},b.applyInput=function(a,b){if(a.c&&this.jTr>0){var c=a.c<this.jTr?a.c:this.jTr;this.vel.y-=c*this.jP,b||q||this.jTr!==this.jT||u.play("jump",.5,!1),this.jTr-=a.c}a.xAxis?(this.vel.x+=a.xAxis*this.accel,(this.vel.x<0&&a.xAxis>0||this.vel.x>0&&a.xAxis<0)&&(this.vel.x*=.95),a.xAxis<0?this.flipped=!0:this.flipped=!1):this.grounded&&(this.vel.x*=.95),this.fired||(this.fV.clear(),a.xAxis&&a.yAxis?(this.fV.x+=a.xAxis>0?this.fS:-this.fS,this.fV.y+=a.yAxis>0?this.fS:-this.fS):a.xAxis?this.fV.x+=a.xAxis>0?2*this.fS:2*-this.fS:a.yAxis?this.fV.y+=a.yAxis>0?2*this.fS:2*-this.fS:this.fV.x+=this.flipped?2*-this.fS:2*this.fS,a.v&&(this.fireBullet(a),u&&u.play("fire",.2,!1))),b&&this.applyMovement()},b.respondToCollision=function(a){switch(a.otherShape.type){case"Spikes":if(!this.damaged&&(this.game.knockBack.copy(a.self).sub(a.otherShape),(q||this.game.singlePlayer)&&this.takeDamage(1,this.game.knockBack),q))for(var b in this.game.players)this.game.players[b].socket.emit("hit",{hurt:this.id,knockBack:{x:this.game.knockBack.x,y:this.game.knockBack.y}});break;case"Hidey":return}switch(a.collisionSide){case"top":this.grounded=!0,this.jTr=this.jT;case"bottom":this.vel.y=0;break;case"left":this.vel.x>0&&(this.vel.x=0),this.moveVec.x=-1;break;case"right":this.vel.x<0&&(this.vel.x=0),this.moveVec.x=1}this.pos.add(a),this.game.constrainToScreen(this)},b}function B(a){a=a||{},this.pos=d(a.x,a.y),this.w=a.w||0,this.h=a.h||0,this.game=a.game,this.type=a.type||"Actor";var b=a.shp;if(!q&&b>=0){this.style=a.style;var c=this.game.assets[this.style];this.shp=c.shapes[b],this.img=c.canvas}this.rL=d(),this.vel=d(),this.mV=4,this.gravity=0,this.grounded=!1,this.visible=!0,this.alpha=1,this.fillStyle=a.fillStyle||"green",Object.defineProperties(this,{x:{get:function(){return this.pos.x},set:function(a){this.pos.x=a}},y:{get:function(){return this.pos.y},set:function(a){this.pos.y=a}}})}function T(){C.on("start",function(a){console.log(a),U(a.players)}),C.on("connect",function(){D=!0,console.log("Connected!",C.id)}),C.on("gameEnded",function(){D=!1,E=null}),C.on("error",function(){console.log("Connection error!")})}function U(a){E=new x({server:!1,canvas:G,draw:H,assets:K,socket:C,players:a,bgB:I,bgC:J,off:S,scl:P})}function V(){F=document.getElementsByTagName("button");for(var a=[function(){console.log("single player"),U([{id:1}])},function(){online&&!D&&(C=io({upgrade:!1,transports:["websocket"]}),T())}],b=0;b<F.length;b++)!function(a,b){a.addEventListener("click",b,!1)}(F[b],a[b])}var m={3:[102,57,49],4:[143,86,59],9:[153,229,80],10:[106,190,48],12:[75,105,47],14:[50,60,57],16:[48,96,130],18:[99,155,255],19:[95,205,228],20:[203,219,252],23:[132,126,135],25:[89,86,82]},n={dirtP:{1:10,2:12,3:3,4:4},dirt:[[,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,1,2,1,1,2,1,2,1,1,2,1,2,2,1],[,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[,3,3,4,3,3,3,3,3,3,3,3,3,3,3],[,3,3,3,3,3,3,3,3,4,3,3,3,3,3],[,3,3,3,3,4,3,3,3,3,3,3,3,3,3],[,3,4,3,3,3,3,3,3,3,3,3,3,4,3],[,3,3,3,3,3,3,3,3,3,3,4,3,3,3],[,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[,3,3,3,3,3,4,3,3,4,3,3,3,3,3],[,3,3,3,3,3,3,3,3,3,3,3,3,4,3],[,3,3,3,3,4,3,3,3,3,3,3,3,3,3],[,3,3,4,3,3,3,3,3,3,3,3,4,3,3],[,,3,3,3,3,3,3,3,3,4,3,3,3,,],[,,,3,3,3,3,3,3,3,3,3,3,,,],[,,,,,,,,,,,,,,,]],guyP:{1:14,2:25,3:18,4:19,5:20},guy:[[,2,2,2,2,0],[3,4,5,5,4,2],[3,4,4,5,5,2],[3,4,4,4,4,2],[3,4,4,4,2,1],[,1,1,1,1],[,2,2,2,2,2],[,2,2,2,2,2],[,2,2,2,2,2],[,2,2,2,2,2],[,2,2,2,2,2],[,1,2,1,1,2],[,1,1,,1,1],[,1,1,,1,1],[,,1,,,1],[,,2,,,2]],gunO:[[9,5],[5,7],[3,13],[4,13],[10,15]],gunP:{1:16,2:12,3:23,4:9},gun:[[[,2,4],[1,3,3],[1,3,3],[1,3,3],[1,3,3],[1,3,3],[1,3,3],[1,3,3]],[[,4,,,,,],[2,3,3,,,,],[1,3,3,3,,,],[,1,3,3,3,,],[,,1,3,3,3],[,,,1,3,3,3],[,,,,1,3,3]],[[4,3,3,3,3,3,3,3],[2,3,3,3,3,3,3,3],[,1,1,1,1,1,1,1]],[[,,,,,3,3],[,,,,3,3,3],[,,,3,3,3,1],[,,3,3,3,1],[,3,3,3,1,,],[4,3,3,1,,,],[,2,1,,,,]],[[3,3,1],[3,3,1],[3,3,1],[3,3,1],[3,3,1],[3,3,1],[3,3,1],[4,2]]]},o=[[2,2],[3,2],[4,2],[2,3],[2,4],[6,2],[2,6],[4,6]],p={level2:[{shp:5,x:10,y:6,style:"dirt"},{shp:4,x:16,y:2,style:"dirt"},{shp:4,x:6,y:4,style:"dirt"},{shp:5,x:6,y:13,style:"dirt"},{shp:5,x:12,y:12,style:"dirt"},{shp:1,x:18,y:14,style:"dirt"},{shp:6,x:21,y:20,dm:!0,style:"dirt"},{shp:5,x:10,y:27,style:"dirt"},{shp:6,x:0,y:8,style:"dirt"},{shp:6,x:0,y:14,style:"dirt"},{shp:7,x:0,y:24,style:"dirt"},{shp:2,x:9,y:20,style:"dirt"}]},q="object"!=typeof window;if(!q){var t=new s;window.jsfxr=function(a){t._params.setSettings(a);var b=t.totalReset(),c=new Uint8Array(4*((b+1)/2|0)+44),d=2*t.synthWave(new Uint16Array(c.buffer,44),b),e=new Uint32Array(c.buffer,0,44);return e[0]=1179011410,e[1]=d+36,e[2]=1163280727,e[3]=544501094,e[4]=16,e[5]=65537,e[6]=44100,e[7]=88200,e[8]=1048578,e[9]=1635017060,e[10]=d,c.buffer};var u=function(){function e(b,d){var e=jsfxr(d);a.decodeAudioData(e,function(a){c[b]=a})}var a,b,c={},d=!0;return{init:function(){a=new AudioContext,b=a.createGain(),b.connect(a.destination),e("kill",[3,,.2,.65,.41,.13,.039,.21,-.026,,.04,.74,.78,,.02,.64,.22,-.18,.98,.05,,.025,-.034,.5]),e("died",[3,,.22,.62,.48,.16,,.21,,,,.73,.81,,,.68,.22,-.19,1,,,,,.5]),e("hurt",[0,.05,.09,.02,.17,.33,,-.35,-.02,.014,.005,-.003,.04,.3,-.01,,.04,,1,,,.2,-.01,.5]),e("hit",[1,,.08,,.2,.7,,-.58,,,,.04,,,,,,,1,,,.15,,.5]),e("jump",[0,,.25,,.23,.3,,.21,,,,,,.04,,,,,.79,,,,,.5]),e("fire",[1,,.27,.13,.11,.93,.24,-.4,-.05,.05,.07,-.003,.03,.7,-.18,.01,.015,-.08,1,-.07,.03,.07,.09,.5]),u.mute()},play:function(d,e,f){var h,g=null;return d in c&&(h=a.createGain(),h.gain.value=e||1,h.connect(b),g=a.createBufferSource(),g.loop=f||!1,g.buffer=c[d],g.connect(h),g.start(0)),g},mute:function(){d=!d,console.log("muted = ",d),b.gain.value=d?0:2}}}();window.onload=function(){window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&u.init(),console.log(u)}}v.prototype={add:function(a){return this.x+=a.x,this.y+=a.y,this},sub:function(a){return this.x-=a.x,this.y-=a.y,this},mag:function(){return Math.abs(Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)))},dis:function(a){return Math.sqrt(Math.pow(a.x-this.x,2)+Math.pow(a.y-this.y,2))},scl:function(a){return this.x*=a,this.y*=a,this},inv:function(){return this.x*=-1,this.y*=-1,this},copy:function(a){return this.x=a.x,this.y=a.y,this},clone:function(){return new v(this.x,this.y)},clear:function(a){return this.x=0,this.y=0,this},normalize:function(){var a=this.mag();return 0!=a&&(this.x/=a,this.y/=a),this},octDir:function(){var a=this.clone().normalize(),b=Math.atan2(a.y,a.x)*(180/Math.PI);return Math.round(b/45)}};x.prototype={init:function(a){var b=this;this.gameStartTime=Date.now(),this.startAt=Date.now()+3e3,this.pause=!0,this.netLatency=100,this.w=352,this.h=240,this.gw=this.w/8,this.gh=this.h/8,this.assets=a.assets,this.players={},this.playerCount=2,this.deadPlayers=0,this.winner=null,this.matchEnded=!1,this.gameEnded=!1,this.bullets={},this.response=d(0,0),this.knockBack=d(0,0),this.player=null;for(var c=0,e=a.players.length;c<e;c++){var f=A({game:this,w:8,h:16,type:"Player",style:"guy",fillStyle:"purple",shp:0});q?(f.socket=a.players[c].socket,f.id=f.socket.id.substr(2)):(f.id=a.players[c],null===a.socket?0===c&&(this.player=f):f.id===a.socket.id&&(this.player=f)),this.players[f.id]=f,this.bullets[f.id]={}}if(q){for(var c in this.players){var f=this.players[c];f.socket.on("input",function(a){b.serverReceiveInput(b,a)})}var g=function(){var a={time:b.gameTime(),bullets:{}};for(var c in b.players){var d=b.players[c],e=b.bullets[d.id],f={};a[d.socket.id.substr(2)]={x:d.pos.x,y:d.pos.y,pos:{x:d.pos.x,y:d.pos.y},fV:{x:d.fV.x,y:d.fV.y},vel:{x:d.vel.x,y:d.vel.y},lastInput:d.lastInput,connected:d.connected};for(var g in e){var h=e[g];f[h.id]={pos:{x:h.pos.x,y:h.pos.y},vel:{x:h.vel.x,y:h.vel.y},fT:h.fT}}a.bullets[d.id]=f,d.connected===!1&&delete b.players[d.id]}for(var c in b.players)b.players[c].socket.emit("state",a)};setInterval(g,50)}else{window.mobile=!1,"undefined"!=typeof window.orientation&&(mobile=!0,window.top.scrollTo(0,1)),this.off=a.off,this.scl=a.scl,this.cover=document.getElementById("cover"),console.log(this.cover),this.cover.style.position="fixed",this.cover.style.left=10*this.w*this.scl+"px",this.bgB=a.bgB,this.bgC=a.bgC,this.bgB.width=352,this.bgB.height=240,this.bgT=0,this.bgI=0,this.bgCh=!0,this.bgB2=h("Sky"),this.socket=a.socket,this.canvas=a.canvas,this.draw=a.draw,this.resetKeys=function(){b.keyRight=!1,b.keyLeft=!1,b.keyUp=!1,b.keyDown=!1},this.resetKeys(),this.inputSeq=0,this.explosions=[];for(var c=0;c<10;c++)this.explosions.push(y(this));this.activeExplosions=[],null!==this.socket?(this.serverUpdates=[],this.serverTime=0,this.updateTime=0,this.socket.on("state",function(a){b.serverUpdates.push(a),b.serverTime=a.time,b.updateTime=Date.now()}),this.socket.on("ready",function(a){b.startAt=a.startAt}),this.socket.on("hit",function(a){var c=b.explosions.pop();c&&c.explode({x:a.x,y:a.y}),a.hurt&&(b.knockBack.copy(a.knockBack),b.players[a.hurt].takeDamage(1,b.knockBack)),a.damaged&&b.level[a.damaged].hit(a.time)}),this.socket.on("levelGlitch",function(a){b.level[a.id].type=a.type}),this.socket.on("matchEnd",function(a){b.pause=!0,b.matchEnded=!0,null!==a.winner&&(b.winner=a.winner,b.players[b.winner].wins++),a.gameEnded?(b.gameEnded=!0,setTimeout(function(){console.log("disconneced"),b.disconnect(),location.reload()},5e3)):setTimeout(function(){b.loadLevel()},2e3)}),this.upV=d(),this.inV=d(),this.disV=d()):this.singlePlayer=!0;var i=function(a){a=a||window.event,a.preventDefault(),39==a.keyCode?b.keyRight="keydown"==a.type:37==a.keyCode?b.keyLeft="keydown"==a.type:38==a.keyCode?b.keyUp="keydown"==a.type:40==a.keyCode?b.keyDown="keydown"==a.type:32==a.keyCode?b.keySpace="keydown"==a.type:67==a.keyCode?b.keyC="keydown"==a.type:86==a.keyCode&&(b.keyV="keydown"==a.type)};document.body.onkeydown=i,document.body.onkeyup=i,this.touches={},this.tStk=d(),this.tStk.id=0,this.stkV=d(),this.fBtn=d(.7*this.canvas.width,.9*this.canvas.height),this.fBtn.id=0,this.jBtn=d(.83*this.canvas.width,.7*this.canvas.height),this.jBtn.id=0;var j=function(a){a.preventDefault(),b.touches={},b.resetKeys();for(var c=0,d=a.touches.length;c<d;c++){var e=a.touches[c];b.touches[e.identifier]={x:e.clientX,y:e.clientY,id:e.identifier}}if(0!==b.tStk.id){var e=b.touches[b.tStk.id];if(e){b.stkV.copy(e).sub(b.tStk);var f=b.stkV.octDir();switch(f){case 0:b.keyRight=!0;break;case 1:b.keyRight=!0;case 2:b.keyDown=!0;break;case 3:b.keyDown=!0;case 4:case-4:b.keyLeft=!0;break;case-3:b.keyLeft=!0;case-2:b.keyUp=!0;break;case-1:b.keyUp=!0,b.keyRight=!0}}else b.tStk.id=0}if(0!==b.fBtn.id){var e=b.touches[b.fBtn.id];e||(b.fBtn.id=0,b.keyV=!1)}if(0!==b.jBtn.id){var e=b.touches[b.jBtn.id];e||(b.jBtn.id=0,b.keyC=!1)}for(var c in b.touches){var e=b.touches[c];0===b.tStk.id&&e.x<b.canvas.width/2&&(b.tStk.id=e.id,b.tStk.copy(e)),0===b.fBtn.id&&b.fBtn.dis(e)<64&&(b.fBtn.id=e.id,b.keyV=!0),0===b.jBtn.id&&b.jBtn.dis(e)<64&&(b.jBtn.id=e.id,b.keyC=!0)}};document.body.ontouchstart=j,document.body.ontouchmove=j,document.body.ontouchend=j}this.loadLevel()},loadLevel:function(){var a=this;this.startAt=Date.now()+3e3,this.matchEnded=!1,this.deadPlayers=0,this.winner=null,this.pause=!0;var b=[{x:10,y:4},{x:33,y:4}],c=0;for(var e in this.players){var f=this.players[e];f.dead=!1,f.x=8*b[c].x,f.y=8*b[c++].y,f.vel.clear(),f.health=5}this.grid=[];for(var g=0;g<this.h/8;g++){this.grid.push([]);for(var h=0;h<this.w/8;h++)this.grid[g].push(1)}this.level=[],this.lastGlitch=Date.now();for(var e=0,i=p.level2.length;e<i;e++){var j=p.level2[e],k=o[j.shp];this.level.push(this.newLevelPiece({game:a,x:j.x,y:j.y,w:k[0],h:k[1],type:j.type,fillStyle:j.fillStyle,shp:j.shp,style:j.style})),j.dm||this.level.push(this.newLevelPiece({game:a,x:a.w/8-j.x-k[0],y:j.y,w:k[0],h:k[1],type:j.type,fillStyle:j.fillStyle,shp:j.shp,style:j.style}))}this.enemies=[],this.deadEnemies=0,this.spawnTime=Date.now(),this.enemiesToSpawn=0,this.difficulty=1;for(var e=0,i=this.level.length;e<i;e++)this.level[e].id=e;if(this.hits=[],this.hit=d(),q)for(var e in this.players)this.players[e].socket.emit("ready",{startAt:this.startAt})},glitchLevel:function(){if((q||this.singlePlayer)&&Date.now()>this.lastGlitch+3e3){this.lastGlitch=Date.now();var b=this.level[a(Math.random()*this.level.length)];if(b.type=["Hidey","Broken","Actor"][a(3*Math.random())],q)for(var c in this.players)this.players[c].socket.emit("levelGlitch",{id:b.id,type:b.type})}},spawnEnemies:function(){this.enemies.length<this.enemiesToSpawn?Date.now()>this.spawnTime+5e3&&(this.enemies.push(A({game:this,x:256,y:8*[2,10,17,24][a(4*Math.random())],w:8,h:16,type:"Enemy",style:"guy",shp:0,fillStyle:"orange"})),this.spawnTime=Date.now()):this.spawningEnemies=!1},newLevelPiece:function(b){for(var c=0;c<b.h;c++)for(var d=0;d<b.w;d++)this.grid[b.y+c][b.x+d]=0;b.x*=8,b.y*=8,b.w*=8,b.h*=8;var e=new B(b);e.visLength=2e3,e.visTime=0,e.update=function(b){switch(this.type){case"Broken":this.visible||Date.now()>this.visTime&&(this.visible=!0),this.rL.x=this.x+a(2*Math.random())-1;case"Actor":this.alpha=1;break;case"Hidey":a(this.game.gameTime()/1e4)%2===0&&(this.alpha=Math.random()/10+.6),this.rL.y=this.y+a(2*Math.random())-1}};var f=e.render;return e.render=function(a){f(a,this)},e.hit=function(a){"Broken"===this.type&&this.visible&&(this.visTime=a||Date.now()+this.visLength,this.visible=!1)},e},gameTime:function(){return Date.now()-this.gameStartTime},matchOver:function(){if(this.pause=!0,this.singlePlayer){this.matchEnded=!0,this.gameEnded=!0,console.log("dead enemies",this.deadEnemies);var a=this;return void setTimeout(function(){a.disconnect(),location.reload()},5e3)}this.winner=null;for(var b in this.players){var c=this.players[b];c.dead||(this.winner=c.id,c.wins++,3===c.wins&&(this.gameEnded=!0))}for(var b in this.players){var c=this.players[b];c.socket.emit("matchEnd",{winner:this.winner,gameEnded:this.gameEnded}),this.gameEnded&&(c.socket.emit("gameEnded"),delete this.players[b])}if(!this.gameEnded){var a=this;setTimeout(function(){a.loadLevel()},2e3)}},begin:function(a,b,c){if(q){!a.matchEnded&&a.deadPlayers>=a.playerCount-1&&(console.log("gameEnding"),a.matchOver(),a.matchEnded=!0),a.serverProcessInput();for(var d in a.players)a.players[d].begin()}else a.player.begin(),a.singlePlayer||(a.syncClientsPlayer(),a.syncNetworkPlayers()),a.clientProcessInput(b)},update:function(a,b){function l(){for(var c in a.bullets)for(var d in a.bullets[c]){var e=a.bullets[c][d];if(e)if(Date.now()>e.fT+500)delete a.bullets[c][d];else{e.update(b);for(var f=0,g=a.level.length;f<g;f++)a.level[f].visible&&"Hidey"!==a.level[f].type&&e.collidesWith(a.level[f],a.response)&&(a.bulletHit(a.response),delete a.bullets[c][d]);for(var f=0,g=a.enemies.length;f<g;f++){var h=a.enemies[f];h.dead||h.id===e.parent.id||e.collidesWith(h,a.response)&&(a.bulletHit(a.response),delete a.bullets[c][d])}for(var f in a.players){var i=a.players[f];i.dead||i.id===e.parent.id||e.collidesWith(i,a.response)&&(a.bulletHit(a.response),delete a.bullets[c][d])}}}}a.bgCh&&a.changeBackground();for(var c=0,d=a.level.length;c<d;c++)a.level[c].update(b);if(!a.pause)for(var c=0,d=a.enemies.length;c<d;c++){var e=a.enemies[c];e.update(b);for(var f=0,g=a.level.length;f<g;f++){var h=a.level[f];h.visible&&e.collidesWith(h,a.response)&&e.respondToCollision(a.response)}}if(a.singlePlayer&&a.deadEnemies===a.enemiesToSpawn&&(console.log(a.deadEnemies,a.enemies.length),a.enemiesToSpawn+=a.difficulty++,a.spawningEnemies=!0),a.spawningEnemies&&a.spawnEnemies(),a.glitchLevel(),q){l();for(var c in a.players){var i=a.players[c];i.update(b);for(var f=0,g=a.level.length;f<g;f++)a.level[f].update(b),a.level[f].visible&&i.collidesWith(a.level[f],a.response)&&i.respondToCollision(a.response)}}else{l();var j=a.player;j.update(b);for(var c=0,d=a.level.length;c<d;c++)a.level[c].update(b),a.level[c].visible&&j.collidesWith(a.level[c],a.response)&&j.respondToCollision(a.response);for(var c=0,d=a.activeExplosions.length;c<d;c++){var k=a.activeExplosions[c];k&&k.update(b)}}},bulletHit:function(a){if(q||this.singlePlayer){this.hit.copy(a.self.centre());var b=a.otherShape,c={x:this.hit.x,y:this.hit.y};if(!b.damaged){switch(b.type){case"Player":this.knockBack.copy(b.centre()).sub(a.self.centre()),this.players[b.id].takeDamage(1,this.knockBack),c.hurt=b.id,c.knockBack={x:this.knockBack.x,y:this.knockBack.y};break;case"Broken":b.hit(),c.damaged=b.id,c.time=b.visTime;break;case"Enemy":b.takeDamage(1,this.knockBack)}if(q)for(var d in this.players)this.players[d].socket.emit("hit",c);this.singlePlayer&&this.explosions.pop().explode({x:this.hit.x,y:this.hit.y})}}},render:function(a,b){a.bgCh||a.draw.clearRect(0,0,a.canvas.width,a.canvas.height),a.draw.save(),a.draw.translate(a.off.x,a.off.y),a.draw.scale(a.scl,a.scl),a.draw.beginPath(),a.draw.rect(0,0,a.w,a.h),a.draw.closePath(),a.draw.clip(),a.draw.drawImage(a.bgB,0,0);for(var c in a.players){var d=a.players[c];d.render(a.draw),d===a.player&&(f(a.draw,d.x+4,d.y-4,2),a.draw.fillStyle="orange",a.draw.fill());for(var g in a.bullets[c])a.bullets[c][g]&&a.bullets[c][g].render(a.draw)}for(var c=0,h=a.enemies.length;c<h;c++){var i=a.enemies[c];i.render(a.draw);for(var g in a.bullets[i.id])a.bullets[i.id][g]&&a.bullets[i.id][g].render(a.draw)}for(var c=0,h=a.level.length;c<h;c++)a.level[c].render(a.draw);for(var c=0,h=a.activeExplosions.length;c<h;c++){var j=a.activeExplosions[c];j.render(a.draw)}for(var c=0;c<a.player.health;c++)f(a.draw,16*(c+1),8,4),a.draw.fillStyle="orange",a.draw.fill(),a.draw.fillStyle="black",a.singlePlayer||a.draw.fillText("Player: "+a.player.id.substr(0,6),96,12);if(a.pause){if(a.draw.fillStyle="black",Date.now()<a.startAt&&(a.draw.font=e(30),a.draw.fillText("Starting in: "+(a.startAt-Date.now())/1e3,80,100)),a.matchEnded&&!a.gameEnded){a.draw.font=e(50),a.draw.fillText("Match Ended",50,50);var k=0;a.draw.font="18px arial";for(var c in a.players)a.draw.fillText(a.players[c].id.substr(0,6)+": "+a.players[c].wins,10,100+20*k++)}if(a.gameEnded)if(a.draw.font=e(50),a.draw.fillText("Game Over",50,50),a.draw.font="18px arial",a.singlePlayer)a.draw.fillText("You killed "+a.deadEnemies+" enemies!",75,100);else{var k=0;for(var c in a.players)c===a.winner&&a.draw.fillText("WINNER",100,100+20*k),a.draw.fillText(a.players[c].id.substr(0,6)+": "+a.players[c].wins,10,100+20*k++)}}a.draw.restore(),mobile&&(0!==a.tStk.id&&(f(a.draw,a.tStk.x,a.tStk.y,64),a.draw.fillStyle="rgba(100,100,100,0.3)",a.draw.fill(),f(a.draw,a.touches[a.tStk.id].x,a.touches[a.tStk.id].y,64),a.draw.fill()),a.draw.fillStyle="rgba(100,100,100,0.5)",f(a.draw,a.fBtn.x,a.fBtn.y,64),a.draw.fill(),f(a.draw,a.jBtn.x,a.jBtn.y,64),a.draw.fill())},end:function(a,b,c){for(var d in a.players)a.players[d].end()},disconnect:function(a){q?this.players[a]&&(this.players[a].connected=!1):(this.mainLoop.stop(),this.draw.clearRect(0,0,this.canvas.width,this.canvas.height),this.cover.style.left="0px")},syncClientsPlayer:function(){for(var a=0,b=this.serverUpdates.length;a<b;a++){var c=this.serverUpdates[a],d=c[this.socket.id];if(c&&!c.checked){c.checked=!0,this.player.lastInput=d.lastInput;for(var e=0;e<this.player.pInp.length;){var f=this.player.pInp[e],g=0;f.inputSeq<=this.player.lastInput?(f.inputSeq===this.player.lastInput&&(this.upV.copy(d),this.inV.copy(f.pos),g=this.upV.dis(this.inV),g>2?this.player.pos.copy(this.upV):g>.01&&this.player.pos.add(this.upV.sub(this.inV).scl(.1)),this.player.vel.copy(d.vel)),this.player.pInp.splice(0,1)):(this.player.applyInput(f,!0),e++)}this.syncBullets(c.bullets)}}},syncNetworkPlayers:function(){for(var a=this.serverTime+(Date.now()-this.updateTime)-this.netLatency,b=null,c=null,d=null,e=0,f=-1,g=0,h=this.serverUpdates.length-1;g<h;g++){var b=this.serverUpdates[g],c=this.serverUpdates[g+1];if(this.serverTime-b.time>1e4)f=g;else if(a>=b.time&&a<c.time)break}if(b&&c){e=(a-b.time)/(c.time-b.time);for(var g in this.players)d=this.players[g],d&&d.id!==this.player.id&&void 0!==c[d.id]&&void 0!==b[d.id]&&(b[d.id].connected!==!1&&c[d.id].connected!==!1?(this.inV.copy(b[d.id]),this.upV.copy(c[d.id]),this.disV.copy(this.upV).sub(this.inV),this.inV.dis(this.upV)>64?d.pos.copy(this.upV).sub(this.disV.scl(1/e)):d.pos.copy(this.inV).add(this.disV.scl(e)),d.fV.copy(b[d.id].fV),d.aimWeapon()):delete this.players[d.id])}f>=0&&this.serverUpdates.splice(0,f+1)},clientProcessInput:function(a){var b=this.player,c=Date.now(),d=this.last_ts||c,e=(c-d)/1e3;if(this.last_ts=c,this.pause)return void(!this.matchEnded&&Date.now()>this.startAt&&(this.pause=!1));if(!b.dead){var f={pos:b.pos,vel:b.vel};this.keyRight&&(f.xAxis=e),this.keyLeft&&(f.xAxis=-e),this.keyUp&&(f.yAxis=-e),this.keyDown&&(f.yAxis=e),this.keySpace&&(f.space=!0),this.keyC&&(f.c=e),this.keyV&&(f.v=e),f.inputSeq=this.inputSeq++,f.playerID=b.id,f.time=c,this.singlePlayer||(this.socket.emit("input",f),this.player.pInp.push(f)),this.player.applyInput(f)}},serverReceiveInput:function(a,b){a.players[b.playerID]&&a.players[b.playerID].pInp.push(b)},serverProcessInput:function(){for(var a in this.players){for(var b=this.players[a],c=0,d=b.pInp.length;c<d;c++){var e=b.pInp[c];b.applyInput(e),b.lastInput=e.inputSeq}b.pInp=[]}},syncBullets:function(a){for(var b in a)if(b!==this.player.id)for(var c in a[b]){var d=a[b][c];this.bullets[b][c]||this.addBullet({x:d.pos.x,y:d.pos.y,vel:d.vel,fT:d.fT,id:c,parent:this.players[b]})}},addBullet:function(a){var b=this,c=new B({game:b,x:a.x,y:a.y,w:4,h:4,type:"Bullet",fillStyle:"black"});c.parent=a.parent,c.vel=d().copy(a.vel),c.fT=a.fT,c.id=a.id,this.bullets[a.parent.id][a.id]=c},constrainToScreen:function(a){(a.x<0||a.x+a.w>this.w||a.y<0||a.y+a.h>this.h)&&(a.centreX()<0?a.x+=this.w:a.centreX()>this.w&&(a.x-=this.w),a.centreY()<0?a.y+=this.h:a.centreY()>this.h&&(a.y-=this.h))},changeBackground:function(){this.bgC.fillStyle="cornflowerblue";for(var b=0;b<5;b++){var c=this.bgI%26,d=a(this.bgI/26);this.bgC.drawImage(this.bgB2,16*c,16*d,16,16,16*c,16*d,16,16),this.bgI++}390===this.bgI&&(this.bgCh=!1)}};var z=2;B.prototype={begin:function(){},update:function(a,b){var b=b||this;b.vel.y+=a*b.gravity,b.applyMovement(),b.game.constrainToScreen(b),b.grounded=!1},applyMovement:function(){this.game.gameEnded&&(this.vel.x*=.95),this.pos.add(this.vel),this.vel.x>.67*this.mV&&(this.vel.x=.67*this.mV),this.vel.x<.67*-this.mV&&(this.vel.x=.67*-this.mV),this.vel.y>this.mV&&(this.vel.y=this.mV),this.vel.y<-this.mV&&(this.vel.y=-this.mV)},render:function(a,b){var b=b||this,c=b.rL||{};a.save(),1!==b.alpha&&(a.globalAlpha=b.alpha),b.visible&&(void 0!==b.shp?a.drawImage(b.img,b.shp.x,b.shp.y,b.shp.w,b.shp.h,c.x||b.x,c.y||b.y,b.shp.w,b.shp.h):(a.fillStyle=b.fillStyle,a.fillRect(c.x||b.x,c.y||b.y,b.w,b.h))),a.restore()},end:function(){},halfWidth:function(){return this.w/2},halfHeight:function(){return this.h/2},centreX:function(){return this.x+this.halfWidth()},centreY:function(){return this.y+this.halfHeight()},centre:function(){return d(this.x+this.halfWidth(),this.y+this.halfHeight())},collidesWith:function(a,b){if(a){this.collisionObject&&b.clear(),b.x=0,b.y=0,b.self=this,b.otherShape=a;var d,e,f=this.centreX()-a.centreX(),g=this.centreY()-a.centreY(),h=this.halfWidth()+a.halfWidth(),i=this.halfHeight()+a.halfHeight();if(Math.abs(f)<h&&Math.abs(g)<i)return d=h-Math.abs(f),e=i-Math.abs(g),d>e?g>0?(b.collisionSide="bottom",b.y=e):(b.collisionSide="top",b.y=-e):f>0?(b.collisionSide="right",b.x=d):(b.collisionSide="left",b.x=-d),b}return!1}};var F,C=null,D=!1,E=null,G=document.createElement("canvas"),H=G.getContext("2d"),I=document.createElement("canvas"),J=I.getContext("2d"),K=j();G.width=window.innerWidth,G.height=window.innerHeight,G.style.position="fixed",G.style.top=0,G.style.left=0,G.style.zIndex=-1,I.width=352,I.height=240,H.imageSmoothingEnabled=!1;var L=G.height,M=G.width,N=L/240,O=M/352,P=N<O?N:O,Q=240*P,R=352*P,S=new v((M-R)/2,(L-Q)/2);
H.save(),H.translate(S.x,S.y),H.scale(P,P),H.drawImage(h("Grid"),0,0),H.restore(),document.body.appendChild(G),window.addEventListener("load",V,!1)}();